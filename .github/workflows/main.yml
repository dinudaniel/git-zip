name: Zip new top-level directories (artifacts + releases)

on:
  push:
    branches:
      - main

jobs:
  zip-dirs:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # REQUIRED for release creation

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect newly added top-level directories
        run: |
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} \
            | awk '$1=="A"{print $2}' \
            | awk -F/ 'NF>1{print $1}' \
            | sort -u > new_dirs.txt

          echo "New top-level directories:"
          cat new_dirs.txt || true

      - name: Zip directories
        run: |
          mkdir -p zips

          while read dir; do
            if [ -d "$dir" ]; then
              echo "Zipping $dir"
              zip -r "zips/${dir}.zip" "$dir"
            fi
          done < new_dirs.txt

      - name: Upload zip artifacts
        uses: actions/upload-artifact@v4
        with:
          name: new-top-level-directories
          path: zips/*.zip
          if-no-files-found: ignore

      - name: Create releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while read dir; do
            if [ -f "zips/${dir}.zip" ]; then
              echo "Creating release for $dir"

              gh release create "$dir" \
                "zips/${dir}.zip" \
                --title "$dir" \
                --notes "Release for folder $dir" \
                || echo "Release $dir already exists"
            fi
          done < new_dirs.txt
